# Code Review: F001 User Authentication

## Verdict
REQUEST_CHANGES

## Summary
The authentication implementation for F001 is well-structured and covers the core OAuth flows for Kakao and Google, JWT session management, and protected route access. The code follows good patterns with clear separation of concerns (routers, services, schemas, models). However, there are several issues that need to be addressed before approval:

1. **Critical**: State parameter (CSRF) is not validated against server-side storage
2. **Major**: Refresh token validation raises `NotImplementedError` in production path
3. **Major**: Access token exposed in URL query parameter during OAuth callback redirect
4. **Minor**: Missing input validation for redirect_uri parameter (potential open redirect)

## Findings

### Blockers

**B1. CSRF State Token Not Validated**
- **File**: `/projects/punch-analytics/backend/api/routers/auth.py`, lines 122-124, 220-221
- **Issue**: The state parameter is parsed but never validated against a server-side session store. The code checks for state existence but does not verify it was generated by the server.
- **Impact**: CSRF attacks possible; attacker could craft a state parameter
- **Fix**: Store state in Redis/database with TTL when generating auth URL, validate on callback

**B2. Refresh Token Validation Not Implemented**
- **File**: `/projects/punch-analytics/backend/api/services/oauth_service.py`, lines 268-283
- **Issue**: `validate_refresh_token()` raises `NotImplementedError`. The `/auth/refresh` endpoint will always fail in production.
- **Impact**: Session refresh (AC-003) cannot work without database integration
- **Fix**: Implement database lookup for refresh tokens, or clearly mark this as blocked until database integration

### Majors

**M1. Access Token in URL Query Parameter**
- **File**: `/projects/punch-analytics/backend/api/routers/auth.py`, lines 150, 245
- **Issue**: JWT access token is passed via URL query parameter: `?access_token={jwt_access_token}`
- **Impact**: Token exposure in browser history, server logs, referrer headers
- **Fix**: Return token in response body via POST, or use fragment identifier (#), or set as HttpOnly cookie

**M2. Refresh Token Not Stored Server-Side**
- **File**: `/projects/punch-analytics/backend/api/routers/auth.py`, lines 146, 241
- **Issue**: `create_refresh_token()` returns hash but it is never persisted to database
- **Impact**: Cannot validate/revoke refresh tokens; session management incomplete
- **Fix**: Persist token_hash to RefreshToken table before setting cookie

**M3. User Not Persisted to Database**
- **File**: `/projects/punch-analytics/backend/api/routers/auth.py`, lines 142-143, 237-238
- **Issue**: Comments indicate "In production, would create/update user in database first" but user is not persisted
- **Impact**: User data lost between sessions; user_id is synthetic and not stable
- **Fix**: Implement user upsert based on provider/provider_id before generating tokens

### Minors

**m1. Open Redirect Potential**
- **File**: `/projects/punch-analytics/backend/api/routers/auth.py`, lines 82, 180
- **Issue**: `redirect_uri` query parameter is not validated; could be exploited
- **Fix**: Validate redirect_uri against allowlist or ensure it's a relative path

**m2. Frontend Token Storage in localStorage**
- **File**: `/projects/punch-analytics/frontend/src/lib/auth/context.tsx`, lines 71-84
- **Issue**: Access token stored in localStorage is accessible to XSS
- **Fix**: Consider using memory-only storage with refresh via HttpOnly cookie

**m3. Missing Error Boundary in AuthProvider**
- **File**: `/projects/punch-analytics/frontend/src/lib/auth/context.tsx`
- **Issue**: Async errors in initAuth could leave component in broken state
- **Fix**: Add try-catch and error state handling

**m4. Hardcoded Default Secret Key**
- **File**: `/projects/punch-analytics/backend/api/config.py`, line 22
- **Issue**: `secret_key: str = "change-me-in-production"` is a weak default
- **Fix**: Remove default or raise error if not set in production

## Required Fixes
1. Implement server-side state validation for CSRF protection (B1)
2. Implement refresh token database storage and validation (B2, M2)
3. Change access token delivery mechanism to avoid URL exposure (M1)
4. Implement user persistence on OAuth callback (M3)

## Evidence

### Files Reviewed
- Backend auth router with OAuth endpoints
- OAuth service with token generation/validation
- Frontend auth context, hooks, and components
- Test suite with comprehensive AC coverage
- Data models for User and RefreshToken

### Positive Observations
- Clean separation: router -> service -> schema pattern
- Proper HttpOnly cookie for refresh token
- Secure cookie settings (secure flag, samesite=lax)
- Comprehensive test coverage for acceptance criteria
- Good error handling with user-friendly messages
- Bilingual UI copy (English + Korean)
- Material Design 3 compliance via MUI

### Test Quality
Tests in `test_auth.py` are meaningful and cover all acceptance criteria. They use proper mocking for external OAuth providers and verify both success and error paths.

## Inputs
- `/Users/briankim/Desktop/ai/agi-dev/projects/punch-analytics/backend/api/routers/auth.py`
- `/Users/briankim/Desktop/ai/agi-dev/projects/punch-analytics/backend/api/services/oauth_service.py`
- `/Users/briankim/Desktop/ai/agi-dev/projects/punch-analytics/backend/api/config.py`
- `/Users/briankim/Desktop/ai/agi-dev/projects/punch-analytics/backend/api/schemas/auth.py`
- `/Users/briankim/Desktop/ai/agi-dev/projects/punch-analytics/backend/api/models/user.py`
- `/Users/briankim/Desktop/ai/agi-dev/projects/punch-analytics/backend/api/main.py`
- `/Users/briankim/Desktop/ai/agi-dev/projects/punch-analytics/backend/tests/conftest.py`
- `/Users/briankim/Desktop/ai/agi-dev/projects/punch-analytics/backend/tests/test_auth.py`
- `/Users/briankim/Desktop/ai/agi-dev/projects/punch-analytics/frontend/src/lib/auth/api.ts`
- `/Users/briankim/Desktop/ai/agi-dev/projects/punch-analytics/frontend/src/lib/auth/context.tsx`
- `/Users/briankim/Desktop/ai/agi-dev/projects/punch-analytics/frontend/src/lib/auth/hooks.ts`
- `/Users/briankim/Desktop/ai/agi-dev/projects/punch-analytics/frontend/src/middleware.ts`
- `/Users/briankim/Desktop/ai/agi-dev/projects/punch-analytics/frontend/src/components/auth/AuthGuard.tsx`
- `/Users/briankim/Desktop/ai/agi-dev/projects/punch-analytics/frontend/src/components/auth/LoginButton.tsx`
- `/Users/briankim/Desktop/ai/agi-dev/projects/punch-analytics/frontend/src/components/auth/LogoutButton.tsx`
- `/Users/briankim/Desktop/ai/agi-dev/projects/punch-analytics/frontend/src/app/(auth)/login/page.tsx`
- `/Users/briankim/Desktop/ai/agi-dev/projects/punch-analytics/frontend/src/app/(protected)/dashboard/page.tsx`
- `/Users/briankim/Desktop/ai/agi-dev/projects/punch-analytics/frontend/src/app/layout.tsx`
