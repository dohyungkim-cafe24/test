"""Tests for stamp generation (F006 - Stamp Generation).

@feature F006 - Stamp Generation

Tests:
- AC-030: Strikes detected by arm velocity and trajectory patterns
- AC-031: Defensive actions detected by torso and arm positioning
- AC-032: Each action timestamped with frame number and confidence
- AC-033: Stamps stored with type, timestamp, side, and confidence
- AC-034: No actions detected proceeds with generic feedback

BDD Scenarios from specs/bdd/processing.feature:
- Strike detection identifies punch types (Jab, Straight, Hook, Uppercut)
- Defensive action detection identifies guards (Guard up, Guard down, Slip, Duck)
- Stamps include confidence scores (action_type, timestamp, frame_number, body_side, confidence)
- No significant actions detected (proceeds with generic feedback)
"""
import pytest
from datetime import datetime, timezone
from uuid import uuid4

from api.models.stamp import Stamp, ActionType, Side
from api.schemas.stamp import StampCreate, StampResponse, StampListResponse


class TestActionTypeEnum:
    """Tests for ActionType enum covering all punch and defense types."""

    def test_action_type_has_all_strike_types(self):
        """Test ActionType enum has all strike types.

        AC-030: Strikes detected by arm velocity and trajectory patterns
        BDD: Strike detection identifies punch types
        """
        # Strike types from DATA_MODEL.md and processing.feature
        assert ActionType.JAB.value == "jab"
        assert ActionType.STRAIGHT.value == "straight"
        assert ActionType.HOOK.value == "hook"
        assert ActionType.UPPERCUT.value == "uppercut"

    def test_action_type_has_all_defensive_types(self):
        """Test ActionType enum has all defensive action types.

        AC-031: Defensive actions detected by torso and arm positioning
        BDD: Defensive action detection identifies guards
        """
        # Defense types from DATA_MODEL.md and processing.feature
        assert ActionType.GUARD_UP.value == "guard_up"
        assert ActionType.GUARD_DOWN.value == "guard_down"
        assert ActionType.SLIP.value == "slip"
        assert ActionType.DUCK.value == "duck"
        assert ActionType.BOB_WEAVE.value == "bob_weave"

    def test_action_type_strike_check(self):
        """Test ActionType can identify strike vs defense."""
        # Strikes
        assert ActionType.JAB.is_strike()
        assert ActionType.STRAIGHT.is_strike()
        assert ActionType.HOOK.is_strike()
        assert ActionType.UPPERCUT.is_strike()

        # Defense (not strikes)
        assert not ActionType.GUARD_UP.is_strike()
        assert not ActionType.SLIP.is_strike()

    def test_action_type_defense_check(self):
        """Test ActionType can identify defense actions."""
        # Defense
        assert ActionType.GUARD_UP.is_defense()
        assert ActionType.GUARD_DOWN.is_defense()
        assert ActionType.SLIP.is_defense()
        assert ActionType.DUCK.is_defense()
        assert ActionType.BOB_WEAVE.is_defense()

        # Strikes (not defense)
        assert not ActionType.JAB.is_defense()
        assert not ActionType.HOOK.is_defense()


class TestSideEnum:
    """Tests for Side enum."""

    def test_side_enum_values(self):
        """Test Side enum has all required values.

        AC-033: Stamps stored with type, timestamp, side, and confidence
        """
        assert Side.LEFT.value == "left"
        assert Side.RIGHT.value == "right"
        assert Side.BOTH.value == "both"


class TestStampModel:
    """Tests for Stamp SQLAlchemy model."""

    def test_stamp_model_creation(self):
        """Test Stamp model can be created with required fields.

        AC-032: Each action timestamped with frame number and confidence
        AC-033: Stamps stored with type, timestamp, side, and confidence
        """
        analysis_id = uuid4()

        stamp = Stamp(
            analysis_id=analysis_id,
            timestamp_seconds=1.5,
            frame_number=45,
            action_type=ActionType.JAB,
            side=Side.LEFT,
            confidence=0.92,
        )

        assert stamp.analysis_id == analysis_id
        assert stamp.timestamp_seconds == 1.5
        assert stamp.frame_number == 45
        assert stamp.action_type == ActionType.JAB
        assert stamp.side == Side.LEFT
        assert stamp.confidence == 0.92

    def test_stamp_model_with_optional_fields(self):
        """Test Stamp model can include velocity and trajectory data."""
        stamp = Stamp(
            analysis_id=uuid4(),
            timestamp_seconds=2.0,
            frame_number=60,
            action_type=ActionType.HOOK,
            side=Side.RIGHT,
            confidence=0.85,
            velocity_vector={"x": 0.5, "y": -0.2, "z": 0.1},
            trajectory_data=[
                {"x": 0.3, "y": 0.5, "frame": 58},
                {"x": 0.4, "y": 0.4, "frame": 59},
                {"x": 0.5, "y": 0.3, "frame": 60},
            ],
        )

        assert stamp.velocity_vector is not None
        assert stamp.velocity_vector["x"] == 0.5
        assert stamp.trajectory_data is not None
        assert len(stamp.trajectory_data) == 3

    def test_stamp_to_dict(self):
        """Test Stamp model to_dict for API response."""
        analysis_id = uuid4()
        stamp_id = uuid4()

        stamp = Stamp(
            id=stamp_id,
            analysis_id=analysis_id,
            timestamp_seconds=3.0,
            frame_number=90,
            action_type=ActionType.GUARD_UP,
            side=Side.BOTH,
            confidence=0.88,
        )

        result = stamp.to_dict()

        assert result["id"] == str(stamp_id)
        assert result["analysis_id"] == str(analysis_id)
        assert result["timestamp_seconds"] == 3.0
        assert result["frame_number"] == 90
        assert result["action_type"] == "guard_up"
        assert result["side"] == "both"
        assert result["confidence"] == 0.88


class TestStampSchemas:
    """Tests for Stamp Pydantic schemas."""

    def test_stamp_create_validation(self):
        """Test StampCreate validates required fields.

        AC-032: Each action timestamped with frame number and confidence
        """
        stamp_data = StampCreate(
            timestamp_seconds=1.5,
            frame_number=45,
            action_type="jab",
            side="left",
            confidence=0.92,
        )

        assert stamp_data.timestamp_seconds == 1.5
        assert stamp_data.frame_number == 45
        assert stamp_data.action_type == "jab"
        assert stamp_data.side == "left"
        assert stamp_data.confidence == 0.92

    def test_stamp_create_confidence_bounds(self):
        """Test StampCreate validates confidence between 0 and 1.

        BDD: confidence scores should be between 0 and 1
        """
        # Valid confidence
        stamp = StampCreate(
            timestamp_seconds=1.0,
            frame_number=30,
            action_type="jab",
            side="left",
            confidence=0.0,  # Min valid
        )
        assert stamp.confidence == 0.0

        stamp = StampCreate(
            timestamp_seconds=1.0,
            frame_number=30,
            action_type="jab",
            side="left",
            confidence=1.0,  # Max valid
        )
        assert stamp.confidence == 1.0

        # Invalid confidence
        with pytest.raises(ValueError):
            StampCreate(
                timestamp_seconds=1.0,
                frame_number=30,
                action_type="jab",
                side="left",
                confidence=1.5,  # Over 1
            )

        with pytest.raises(ValueError):
            StampCreate(
                timestamp_seconds=1.0,
                frame_number=30,
                action_type="jab",
                side="left",
                confidence=-0.1,  # Under 0
            )

    def test_stamp_create_action_type_validation(self):
        """Test StampCreate validates action type.

        BDD: detected strikes should be classified as Jab, Straight, Hook, Uppercut
        BDD: detected actions should include Guard up, Guard down, Slip, Duck
        """
        valid_types = [
            "jab", "straight", "hook", "uppercut",
            "guard_up", "guard_down", "slip", "duck", "bob_weave"
        ]

        for action_type in valid_types:
            stamp = StampCreate(
                timestamp_seconds=1.0,
                frame_number=30,
                action_type=action_type,
                side="left",
                confidence=0.8,
            )
            assert stamp.action_type == action_type

        # Invalid action type
        with pytest.raises(ValueError):
            StampCreate(
                timestamp_seconds=1.0,
                frame_number=30,
                action_type="invalid_type",
                side="left",
                confidence=0.8,
            )

    def test_stamp_create_side_validation(self):
        """Test StampCreate validates side."""
        valid_sides = ["left", "right", "both"]

        for side in valid_sides:
            stamp = StampCreate(
                timestamp_seconds=1.0,
                frame_number=30,
                action_type="jab",
                side=side,
                confidence=0.8,
            )
            assert stamp.side == side

        # Invalid side
        with pytest.raises(ValueError):
            StampCreate(
                timestamp_seconds=1.0,
                frame_number=30,
                action_type="jab",
                side="invalid_side",
                confidence=0.8,
            )

    def test_stamp_response_structure(self):
        """Test StampResponse has correct structure.

        BDD: each stamp should include action_type, timestamp, frame_number, body_side, confidence
        """
        response = StampResponse(
            id=str(uuid4()),
            analysis_id=str(uuid4()),
            timestamp_seconds=1.5,
            frame_number=45,
            action_type="jab",
            side="left",
            confidence=0.92,
            created_at=datetime.now(timezone.utc),
        )

        assert response.id is not None
        assert response.analysis_id is not None
        assert response.timestamp_seconds == 1.5
        assert response.frame_number == 45
        assert response.action_type == "jab"
        assert response.side == "left"
        assert response.confidence == 0.92
        assert response.created_at is not None

    def test_stamp_list_response(self):
        """Test StampListResponse for multiple stamps."""
        stamps = [
            StampResponse(
                id=str(uuid4()),
                analysis_id=str(uuid4()),
                timestamp_seconds=1.0,
                frame_number=30,
                action_type="jab",
                side="left",
                confidence=0.9,
                created_at=datetime.now(timezone.utc),
            ),
            StampResponse(
                id=str(uuid4()),
                analysis_id=str(uuid4()),
                timestamp_seconds=2.0,
                frame_number=60,
                action_type="guard_up",
                side="both",
                confidence=0.85,
                created_at=datetime.now(timezone.utc),
            ),
        ]

        response = StampListResponse(
            stamps=stamps,
            total=2,
            strikes_count=1,
            defense_count=1,
        )

        assert len(response.stamps) == 2
        assert response.total == 2
        assert response.strikes_count == 1
        assert response.defense_count == 1


class TestStampDetectionService:
    """Tests for StampDetectionService.

    AC-030: Strikes detected by arm velocity and trajectory patterns
    AC-031: Defensive actions detected by torso and arm positioning
    """

    def test_detect_strikes_jab(self):
        """Test jab detection from pose data.

        AC-030: Strikes detected by arm velocity and trajectory patterns
        BDD: Strike detection identifies punch types - Jab
        """
        from api.services.stamp_detection_service import StampDetectionService

        service = StampDetectionService()

        # Simulated pose data with arm extension pattern for jab
        pose_data = {
            "frames": [
                _create_pose_frame(i, arm_extended=(i >= 28 and i <= 32), arm_side="left")
                for i in range(60)
            ],
            "fps": 30.0,
        }

        strikes = service.detect_strikes(pose_data)

        # Should detect a jab
        assert len(strikes) >= 1
        jab_stamps = [s for s in strikes if s["action_type"] == "jab"]
        assert len(jab_stamps) >= 1
        assert jab_stamps[0]["side"] == "left"
        assert 0 <= jab_stamps[0]["confidence"] <= 1

    def test_detect_strikes_hook(self):
        """Test hook detection from pose data.

        AC-030: Strikes detected by arm velocity and trajectory patterns
        BDD: Strike detection identifies punch types - Hook
        """
        from api.services.stamp_detection_service import StampDetectionService

        service = StampDetectionService()

        # Simulated pose data with circular arm trajectory for hook
        pose_data = {
            "frames": [
                _create_pose_frame(i, hook_motion=(i >= 28 and i <= 35), arm_side="right")
                for i in range(60)
            ],
            "fps": 30.0,
        }

        strikes = service.detect_strikes(pose_data)

        hook_stamps = [s for s in strikes if s["action_type"] == "hook"]
        assert len(hook_stamps) >= 1
        assert hook_stamps[0]["side"] == "right"

    def test_detect_defense_guard_up(self):
        """Test guard up detection from pose data.

        AC-031: Defensive actions detected by torso and arm positioning
        BDD: Defensive action detection identifies guards - Guard up
        """
        from api.services.stamp_detection_service import StampDetectionService

        service = StampDetectionService()

        # Simulated pose data with hands raised near face
        pose_data = {
            "frames": [
                _create_pose_frame(i, guard_up=(i >= 20 and i <= 40))
                for i in range(60)
            ],
            "fps": 30.0,
        }

        defense = service.detect_defense(pose_data)

        guard_up_stamps = [d for d in defense if d["action_type"] == "guard_up"]
        assert len(guard_up_stamps) >= 1
        assert guard_up_stamps[0]["side"] == "both"

    def test_detect_defense_slip(self):
        """Test slip detection from pose data.

        AC-031: Defensive actions detected by torso and arm positioning
        BDD: Defensive action detection identifies guards - Slip
        """
        from api.services.stamp_detection_service import StampDetectionService

        service = StampDetectionService()

        # Simulated pose data with torso lateral movement
        pose_data = {
            "frames": [
                _create_pose_frame(i, slip_motion=(i >= 25 and i <= 30))
                for i in range(60)
            ],
            "fps": 30.0,
        }

        defense = service.detect_defense(pose_data)

        slip_stamps = [d for d in defense if d["action_type"] == "slip"]
        assert len(slip_stamps) >= 1

    def test_detect_defense_duck(self):
        """Test duck detection from pose data.

        AC-031: Defensive actions detected by torso and arm positioning
        BDD: Defensive action detection identifies guards - Duck
        """
        from api.services.stamp_detection_service import StampDetectionService

        service = StampDetectionService()

        # Simulated pose data with lowered head/torso
        pose_data = {
            "frames": [
                _create_pose_frame(i, duck_motion=(i >= 25 and i <= 30))
                for i in range(60)
            ],
            "fps": 30.0,
        }

        defense = service.detect_defense(pose_data)

        duck_stamps = [d for d in defense if d["action_type"] == "duck"]
        assert len(duck_stamps) >= 1


class TestStampGenerationService:
    """Tests for StampGenerationService (orchestration).

    AC-032: Each action timestamped with frame number and confidence
    AC-033: Stamps stored with type, timestamp, side, and confidence
    AC-034: No actions detected proceeds with generic feedback
    """

    @pytest.mark.asyncio
    async def test_generate_stamps_creates_records(self):
        """Test generate_stamps creates stamp records in database.

        AC-033: Stamps stored with type, timestamp, side, and confidence
        """
        from api.services.stamp_generation_service import StampGenerationService

        service = StampGenerationService()
        analysis_id = uuid4()

        # Simulated pose data with some actions
        pose_data = {
            "frames": [
                _create_pose_frame(i, arm_extended=(i >= 28 and i <= 32), arm_side="left")
                for i in range(60)
            ],
            "fps": 30.0,
        }

        # This would normally use a database session
        # For unit test, we test the detection logic
        stamps = service.detect_all_actions(pose_data)

        assert isinstance(stamps, list)
        for stamp in stamps:
            assert "action_type" in stamp
            assert "timestamp_seconds" in stamp
            assert "frame_number" in stamp
            assert "side" in stamp
            assert "confidence" in stamp

    @pytest.mark.asyncio
    async def test_generate_stamps_no_actions(self):
        """Test generate_stamps handles videos with no detected actions.

        AC-034: No actions detected proceeds with generic feedback
        BDD: No significant actions detected - analysis should proceed
        """
        from api.services.stamp_generation_service import StampGenerationService

        service = StampGenerationService()

        # Simulated pose data with minimal movement (no detectable actions)
        pose_data = {
            "frames": [
                _create_pose_frame(i, minimal_movement=True)
                for i in range(60)
            ],
            "fps": 30.0,
        }

        stamps = service.detect_all_actions(pose_data)

        # Should return empty list but not fail
        assert isinstance(stamps, list)
        # Note: empty list is valid - AC-034 says it should proceed

    @pytest.mark.asyncio
    async def test_stamps_include_confidence_scores(self):
        """Test all stamps include confidence scores.

        BDD: Stamps include confidence scores - confidence should be between 0 and 1
        """
        from api.services.stamp_generation_service import StampGenerationService

        service = StampGenerationService()

        pose_data = {
            "frames": [
                _create_pose_frame(
                    i,
                    arm_extended=(i >= 28 and i <= 32),
                    arm_side="left",
                    guard_up=(i >= 45 and i <= 50)
                )
                for i in range(60)
            ],
            "fps": 30.0,
        }

        stamps = service.detect_all_actions(pose_data)

        for stamp in stamps:
            assert "confidence" in stamp
            assert 0 <= stamp["confidence"] <= 1


class TestProcessingPipelineIntegration:
    """Tests for stamp generation integration with processing pipeline."""

    @pytest.mark.asyncio
    async def test_processing_transitions_to_stamp_generation(self):
        """Test processing pipeline transitions to stamp_generation after pose.

        Verifies integration point in processing service.
        """
        from api.services.processing_service import ProcessingService
        from api.models.analysis import AnalysisStatus

        # The processing service should support stamp_generation status
        assert AnalysisStatus.STAMP_GENERATION.value == "stamp_generation"

    def test_analysis_model_has_stamp_timestamps(self):
        """Test Analysis model has stamp stage timestamps."""
        from api.models.analysis import Analysis

        analysis = Analysis(
            video_id=uuid4(),
            user_id=uuid4(),
            subject_id=uuid4(),
            body_specs_id=uuid4(),
        )

        # Should have stamp timestamp fields
        assert hasattr(analysis, "stamps_started_at")
        assert hasattr(analysis, "stamps_completed_at")


# --- Helper Functions for Test Data ---

def _create_pose_frame(
    frame_number: int,
    arm_extended: bool = False,
    arm_side: str = "left",
    hook_motion: bool = False,
    guard_up: bool = False,
    slip_motion: bool = False,
    duck_motion: bool = False,
    minimal_movement: bool = False,
) -> dict:
    """Create a simulated pose frame for testing.

    Uses MediaPipe 33-joint landmarks. Key joints:
    - 11, 12: left/right shoulder
    - 13, 14: left/right elbow
    - 15, 16: left/right wrist
    - 0: nose (for head position)
    - 23, 24: left/right hip (for torso position)
    """
    # Base positions (standing neutral)
    joints = {}
    for i in range(33):
        joints[i] = {"x": 0.5, "y": 0.5, "z": 0.0, "visibility": 0.9}

    fps = 30.0
    timestamp = frame_number / fps

    # Modify based on action flags
    if arm_extended:
        if arm_side == "left":
            # Left arm extended forward (jab-like motion)
            joints[13] = {"x": 0.3, "y": 0.4, "z": -0.2, "visibility": 0.95}  # elbow
            joints[15] = {"x": 0.1, "y": 0.4, "z": -0.4, "visibility": 0.95}  # wrist
        else:
            # Right arm extended
            joints[14] = {"x": 0.7, "y": 0.4, "z": -0.2, "visibility": 0.95}
            joints[16] = {"x": 0.9, "y": 0.4, "z": -0.4, "visibility": 0.95}

    if hook_motion:
        if arm_side == "right":
            # Circular arm trajectory for hook
            joints[14] = {"x": 0.7, "y": 0.3, "z": -0.1, "visibility": 0.95}
            joints[16] = {"x": 0.6, "y": 0.3, "z": -0.2, "visibility": 0.95}

    if guard_up:
        # Both hands raised near face
        joints[15] = {"x": 0.4, "y": 0.3, "z": -0.1, "visibility": 0.95}  # left wrist
        joints[16] = {"x": 0.6, "y": 0.3, "z": -0.1, "visibility": 0.95}  # right wrist

    if slip_motion:
        # Torso shifted laterally
        joints[11] = {"x": 0.3, "y": 0.4, "z": 0.0, "visibility": 0.95}  # left shoulder
        joints[12] = {"x": 0.5, "y": 0.4, "z": 0.0, "visibility": 0.95}  # right shoulder

    if duck_motion:
        # Head and torso lowered
        joints[0] = {"x": 0.5, "y": 0.6, "z": 0.0, "visibility": 0.95}  # nose
        joints[11] = {"x": 0.4, "y": 0.5, "z": 0.0, "visibility": 0.95}
        joints[12] = {"x": 0.6, "y": 0.5, "z": 0.0, "visibility": 0.95}

    if minimal_movement:
        # All joints in neutral position
        pass

    # Convert to list format expected by pose data
    joint_list = [
        {
            "joint_id": i,
            "name": f"joint_{i}",
            **joints[i],
        }
        for i in range(33)
    ]

    return {
        "frame_number": frame_number,
        "timestamp_seconds": timestamp,
        "joints": joint_list,
        "confidence": 0.9,
    }
